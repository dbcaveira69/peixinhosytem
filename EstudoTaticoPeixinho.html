<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Controle de Estudos - Peixinho</title>
    
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBkPSJNNTAgNSBMMTAgMjAgVjQ1IEMxMCA3MCAzMCA5MCA1MCA5NSBDNzAgOTAgOTAgNzAgOTAgNDUgVjIwIFoiIGZpbGw9IiMxMjE0MTYiIHN0cm9rZT0iI2ZmNDA4MSIgc3Ryb2tlLXdpZHRoPSI1Ii8+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iMjAiIGZpbGw9Im5vbmUiIHN0cm9rZT0iI2ZmNDA4MSIgc3Ryb2tlLXdpZHRoPSI0Ii8+PHBhdGggZD0iTTUwIDIwIEw1MCA4MCBNMjAgNTAgTDgwIDUwIiBzdHJva2U9IiNmZjQwODEiIHN0cm9rZS13aWR0aD0iNCIvPjwvc3ZnPg==" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- ESTILOS TÁTICOS PFEM --- */
        :root {
            --bg-body: #121416; --bg-panel: #1e2124;
            --primary: #c2185b; --primary-dark: #880e4f;
            --tech-accent: #ff4081; --tech-glow: 0 0 10px rgba(255, 64, 129, 0.3);
            --text-main: #e0e0e0; --text-muted: #8899a6; --border: #383f45;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-body) radial-gradient(#2c2f33 1px, transparent 1px) 0 0/20px 20px; color: var(--text-main); padding: 30px; padding-bottom: 0; min-height: 100vh; }
        .container { width: 100%; max-width: 1200px; margin: 0 auto; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); min-height: calc(100vh - 60px); display: flex; flex-direction: column; overflow: hidden; }
        
        .main-header { background: linear-gradient(180deg, #2b3035 0%, #1c1f22 100%); border-bottom: 2px solid var(--primary); padding: 20px 30px; display: flex; justify-content: center; align-items: center; position: relative;}
        .title-line { display: flex; align-items: center; gap: 15px; }
        .main-icon { font-size: 32px; color: var(--tech-accent); filter: drop-shadow(0 0 5px rgba(255, 64, 129, 0.5)); }
        .logo-title { font-family: 'Rajdhani', sans-serif; font-size: 30px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; color: var(--text-main); margin: 0;}
        
        .tabs { display: flex; background: #181a1d; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab-btn { padding: 18px 20px; background: none; border: none; cursor: pointer; font-weight: 600; color: #8899a6; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; font-family: 'Rajdhani'; border-bottom: 3px solid transparent; transition: 0.3s; flex: 1; white-space: nowrap; }
        .tab-btn.active { color: var(--tech-accent); border-bottom-color: var(--tech-accent); background: rgba(255, 64, 129, 0.05); }
        .content { padding: 30px; display: none; animation: fadeIn 0.3s; flex: 1; overflow-y: auto;}
        .content.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(5px); } to { opacity:1; transform:translateY(0); } }

        .section-title { font-family: 'Rajdhani', sans-serif; font-size: 22px; color: var(--text-main); margin-bottom: 20px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; border-left: 4px solid var(--primary); padding-left: 15px; display: flex; justify-content: space-between; align-items: center;}

        button { border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 700; padding: 12px 25px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; text-transform: uppercase; letter-spacing: 1px; font-family: 'Rajdhani'; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; border: 1px solid rgba(255,255,255,0.1); }
        .btn-primary:hover { background: var(--primary-dark); border-color: var(--tech-accent); box-shadow: 0 0 10px rgba(255, 64, 129, 0.3); }
        .btn-del { background: #96281b; color: white; }
        .btn-icon { width: 35px; height: 35px; padding: 0; border-radius: 4px; color: white; font-size: 14px; }
        .btn-edit { background: #ffa000; color: #000; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card-stat { background: linear-gradient(135deg, #1e2124 0%, #181a1d 100%); padding: 20px; border-radius: 4px; border: 1px solid var(--border); text-align: center; border-left: 4px solid var(--primary); }
        .card-stat h4 { color: #888; font-size: 12px; text-transform: uppercase; margin-bottom: 10px; }
        .card-stat .value { font-family: 'Rajdhani'; font-size: 28px; font-weight: 700; color: var(--tech-accent); }

        .chart-box { background: #16181b; padding: 20px; border-radius: 4px; border: 1px solid var(--border); position: relative; height: 320px; margin-bottom: 20px; }
        
        /* FILTROS E TABELAS */
        .filter-bar { display: flex; gap: 10px; background: #16181b; padding: 15px; border: 1px solid var(--border); margin-bottom: 20px; border-radius: 4px; align-items: center; flex-wrap: wrap; }
        .filter-control { padding: 10px; border: 1px solid #444; border-radius: 2px; font-size: 13px; background: #121416; color: white; flex: 1; min-width: 130px; outline: none; }
        .filter-control:focus { border-color: var(--tech-accent); }

        .table-container { border-radius: 4px; border: 1px solid var(--border); background: #181a1d; overflow-x: auto; max-height: 60vh; margin-bottom: 20px;}
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        thead { background: #0f1012; color: var(--tech-accent); position: sticky; top: 0; z-index: 10; border-bottom: 2px solid var(--primary); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; color: #ccc;}
        .subject-badge { background: rgba(194, 24, 91, 0.2); color: var(--tech-accent); border: 1px solid var(--primary); padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; text-transform: uppercase; }

        /* ABA EDITAL */
        .edital-header-row { background: var(--primary-dark); color: white; font-weight: bold; text-transform: uppercase; font-size: 14px; }
        .edital-header-row td { padding: 15px; border-bottom: none; color: white; }
        .edital-item-row { background: #16181b; transition: 0.2s; }
        .edital-item-row:hover { background: #1e2124; }
        .edital-num { font-weight: bold; color: #888; width: 50px; text-align: center; }
        .chk-edital { width: 18px; height: 18px; accent-color: var(--tech-accent); cursor: pointer; }
        .edital-progress-bar { width: 100%; height: 6px; background: #333; margin-top: 10px; border-radius: 3px; overflow: hidden; }
        .edital-progress-fill { height: 100%; background: var(--tech-accent); width: 0%; transition: width 0.5s; }

        /* FILTRO ANÁLISE (ESTILO APROVADO) */
        .an-filter-container { background: #16181b; border: 1px solid var(--border); border-radius: 6px; padding: 20px; margin-bottom: 20px; }
        .an-dates-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .an-date-group { display: flex; flex-direction: column; flex: 1; min-width: 150px;}
        .an-date-group label { font-size: 10px; color: #888; text-transform: uppercase; margin-bottom: 5px; font-weight: bold;}
        .an-date-input { background: #121416; border: 1px solid #444; color: white; padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 14px; outline: none; width: 100%;}
        
        .quick-dates-group { display: flex; gap: 5px; flex-wrap: wrap; align-items: flex-end; }
        .btn-quick-date { background: #222; border: 1px solid #444; color: #aaa; padding: 10px 15px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-quick-date:hover { border-color: var(--tech-accent); color: white; }
        .btn-quick-date.active { background: var(--tech-accent); color: white; border-color: var(--tech-accent); }

        .analysis-split { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #16181b; border: 1px solid var(--border); border-radius: 4px; padding: 20px; }
        .an-chart-container { position: relative; height: 350px; }
        .an-list-container { max-height: 350px; overflow-y: auto; padding-right: 10px; }
        .an-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #333; font-size: 13px; }
        .an-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 10px; }
        .an-materia-nome { color: var(--text-main); font-weight: 500; flex: 1; }
        .an-tempo { color: var(--text-muted); font-family: 'Courier New', monospace; margin-right: 10px; }
        .an-pct { font-weight: bold; color: var(--tech-accent); width: 45px; text-align: right; }

        /* CALENDÁRIO & CRONÔMETRO */
        .calendar-wrapper { background: #16181b; border: 1px solid var(--border); padding: 15px; border-radius: 4px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .day-cell { background: #1e2124; border: 1px solid #333; min-height: 80px; padding: 5px; display: flex; flex-direction: column; border-radius: 4px; transition: 0.2s;}
        .day-cell:hover { border-color: var(--tech-accent); }
        .day-num { font-weight: bold; color: #888; font-size: 12px; margin-bottom: 5px; text-align: right; }
        .day-studied { background: rgba(255, 64, 129, 0.1); border-color: var(--primary); }
        .day-hours { font-family: 'Rajdhani'; font-size: 16px; font-weight: bold; color: var(--tech-accent); text-align: center; margin-top: auto; }

        .timer-container { text-align: center; padding: 40px 20px; background: #16181b; border: 1px solid var(--primary); border-radius: 8px; box-shadow: 0 0 20px rgba(194, 24, 91, 0.2); margin-bottom: 30px;}
        .timer-display { font-family: 'Courier New', monospace; font-size: 70px; font-weight: bold; color: var(--tech-accent); margin-bottom: 20px; text-shadow: 0 0 15px rgba(255, 64, 129, 0.5); }
        
        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #1e2124; width: 100%; max-width: 600px; padding: 25px; border: 1px solid var(--primary); border-radius: 6px; max-height: 95vh; overflow-y: auto;}
        
        /* Form Estilo Aprovado */
        .aprovado-row { display: flex; gap: 20px; margin-bottom: 15px; align-items: flex-end; flex-wrap: wrap;}
        .aprovado-group { flex: 1; min-width: 150px; }
        .aprovado-label { display: block; font-size: 12px; color: #888; margin-bottom: 8px; font-weight: bold; }
        .aprovado-input { width: 100%; padding: 10px; background: #121416; border: 1px solid #444; color: white; border-radius: 4px; font-size: 14px; outline: none; }
        .aprovado-input:focus { border-color: var(--tech-accent); }
        
        .time-inputs { display: flex; gap: 10px; align-items: center; }
        .time-inputs input { width: 60px; text-align: center; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; background: #4caf50; color: white; padding: 15px 25px; border-radius: 4px; font-weight: bold; display: none; z-index: 3000; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        @media (max-width: 768px) {
            body { padding: 0; }
            .container { max-width: 100%; border-radius: 0; border: none; min-height: 100vh; }
            .tabs { overflow-x: scroll; }
            .timer-display { font-size: 50px; }
            .analysis-split { grid-template-columns: 1fr; }
        }

        /* --- LIGHT MODE --- */
        body.light-mode {
            --bg-body: #f4f4f5; --bg-panel: #ffffff;
            --primary: #880e4f; --primary-dark: #4a0024;    
            --tech-accent: #d81b60; --text-main: #18181b; --text-muted: #52525b; --border: #d4d4d8;
            background-image: radial-gradient(#d4d4d8 1px, transparent 1px);
        }
        body.light-mode .main-header { background: #ffffff; border-bottom: 2px solid var(--primary); }
        body.light-mode .logo-title { color: var(--primary); }
        body.light-mode .tabs { background: #f4f4f5; border-color: #d4d4d8; }
        body.light-mode .tab-btn { color: #555; }
        body.light-mode .tab-btn:hover { background: rgba(0,0,0,0.05); }
        body.light-mode .tab-btn.active { background: rgba(216, 27, 96, 0.1); color: var(--tech-accent); border-bottom-color: var(--tech-accent); }
        body.light-mode .card-stat, body.light-mode .chart-box, body.light-mode .table-container, body.light-mode .calendar-wrapper, body.light-mode .timer-container, body.light-mode .analysis-split, body.light-mode .filter-bar, body.light-mode .an-filter-container { background: #ffffff; border-color: #d4d4d8; }
        body.light-mode table thead { background: #e4e4e7; color: var(--primary); border-bottom-color: #d4d4d8; }
        body.light-mode th, body.light-mode td { border-bottom-color: #d4d4d8; color: #333; }
        body.light-mode .day-cell { background: #f4f4f5; border-color: #d4d4d8; }
        body.light-mode .day-studied { background: rgba(216, 27, 96, 0.1); border-color: var(--primary); }
        body.light-mode .modal-box { background: #ffffff; border-color: var(--primary); }
        
        body.light-mode .filter-control, body.light-mode .an-date-input, body.light-mode .aprovado-input { background: #ffffff; color: #18181b; border-color: #a1a1aa; }
        body.light-mode .filter-control:focus, body.light-mode .an-date-input:focus, body.light-mode .aprovado-input:focus { border-color: var(--primary); }
        
        body.light-mode .btn-date, body.light-mode .btn-quick-date { background: #e4e4e7; color: #555; border-color: #d4d4d8; }
        body.light-mode .btn-date.active, body.light-mode .btn-quick-date.active { background: var(--primary); color: white; border-color: var(--primary); }
        body.light-mode .an-list-item { border-bottom-color: #d4d4d8; }
        body.light-mode .an-materia-nome { color: #18181b; }
        body.light-mode .edital-header-row { background: #fce4ec; color: #880e4f; }
        body.light-mode .edital-header-row td { color: #880e4f; }
        body.light-mode .edital-item-row { background: #ffffff; }
        body.light-mode .edital-item-row:hover { background: #f4f4f5; }
    </style>
</head>
<body>

    <div id="toast" class="toast">Ação realizada com sucesso!</div>

    <div id="modal-importar" class="modal-overlay" style="z-index: 2600;">
        <div class="modal-box">
            <h3 style="color:var(--tech-accent); font-family:'Rajdhani'; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:15px;"><i class="fas fa-paste"></i> IMPORTAR EDITAL</h3>
            <p style="font-size:12px; color:#888; margin-bottom:10px;">Cole o texto do seu edital. O sistema tentará organizar Matérias e Tópicos automaticamente baseado em números e letras maiúsculas.</p>
            <textarea id="import-texto" class="aprovado-input" rows="10" placeholder="Ex:\n1 LÍNGUA PORTUGUESA\n1.1 Compreensão de textos\n1.2 Tipologia textual..."></textarea>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-primary" style="flex:1" onclick="processarImportacao()"><i class="fas fa-magic"></i> PROCESSAR TEXTO</button>
                <button class="btn-del" style="flex:1" onclick="document.getElementById('modal-importar').style.display='none'">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-nova-materia" class="modal-overlay" style="z-index: 2500;">
        <div class="modal-box" style="max-width: 400px; border: 2px solid var(--tech-accent);">
            <h3 style="color:var(--tech-accent); font-family:'Rajdhani'; border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:15px;">NOVO TÓPICO / MATÉRIA</h3>
            
            <div class="aprovado-group" style="margin-bottom:15px;">
                <label class="aprovado-label">DISCIPLINA PRINCIPAL</label>
                <select id="nova-topico-materia" class="aprovado-input">
                    <option value="">[ + CRIAR NOVA MATÉRIA ]</option>
                </select>
            </div>

            <div class="aprovado-group">
                <label class="aprovado-label">NOME DO TÓPICO OU NOVA MATÉRIA</label>
                <input type="text" id="nova-topico-input" class="aprovado-input" placeholder="Ex: Informática ou Windows 10">
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-primary" style="flex:1" onclick="salvarNovoTopicoEdital()">SALVAR</button>
                <button class="btn-del" style="flex:1" onclick="document.getElementById('modal-nova-materia').style.display='none'">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-atividade" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px;">
                <h3 style="color:var(--text-main); font-family:'Rajdhani'; font-size:24px; text-transform: uppercase; margin:0;"><i class="fas fa-edit" style="color:var(--tech-accent)"></i> Cadastrar nova atividade</h3>
                <button onclick="document.getElementById('modal-atividade').style.display='none'" style="background:none; border:none; font-size:20px; color:#888; cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            
            <input type="hidden" id="edit-id">
            
            <div class="aprovado-row">
                <div class="aprovado-group" style="flex: 2;">
                    <label class="aprovado-label">Matéria</label>
                    <select id="m-materia" class="aprovado-input" onchange="atualizarTopicosRegistro()"></select>
                </div>
                <div class="aprovado-group" style="flex: 2;">
                    <label class="aprovado-label">Conteúdo</label>
                    <select id="m-conteudo" class="aprovado-input">
                        <option value="">-- Escolha um conteúdo --</option>
                    </select>
                </div>
            </div>
            
            <div class="aprovado-row">
                <div class="aprovado-group">
                    <label class="aprovado-label">Data de Início</label>
                    <input type="date" id="m-data" class="aprovado-input">
                </div>
                <div class="aprovado-group">
                    <label class="aprovado-label">Duração (Tempo Líquido)</label>
                    <div class="time-inputs">
                        <input type="number" id="m-duracao-horas" class="aprovado-input" placeholder="0" min="0"> <span style="color:#888; font-size:12px;">Horas</span>
                        <input type="number" id="m-duracao-min" class="aprovado-input" placeholder="0" min="0" max="59"> <span style="color:#888; font-size:12px;">Min</span>
                    </div>
                </div>
            </div>

            <div class="aprovado-group" style="margin-top: 15px;">
                <label class="aprovado-label">Anotações / Questões (Opcional)</label>
                <textarea id="m-notas" class="aprovado-input" rows="3" placeholder="Faça suas anotações aqui! Ex: Fiz 20 questões, errei 3."></textarea>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:30px; border-top:1px solid #333; padding-top:20px;">
                <button style="background:#555; color:#fff; border:none; padding:12px 20px; border-radius:4px; font-weight:bold; cursor:pointer;" onclick="document.getElementById('modal-atividade').style.display='none'"><i class="fas fa-times"></i> Cancelar</button>
                <button class="btn-primary" style="background:#4caf50; padding:12px 30px;" onclick="salvarAtividade()"><i class="fas fa-check"></i> Salvar</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-header">
            <div class="title-line">
                <h1 class="logo-title">CONTROLE DE ESTUDOS</h1>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="nav('dashboard', this)"><i class="fas fa-chart-pie"></i> Início</button>
            <button class="tab-btn" onclick="nav('edital', this)"><i class="fas fa-list-check"></i> Edital</button>
            <button class="tab-btn" onclick="nav('historico', this)"><i class="fas fa-history"></i> Histórico</button>
            <button class="tab-btn" onclick="nav('analise', this)"><i class="fas fa-bullseye"></i> Análise</button>
            <button class="tab-btn" onclick="nav('cronometro', this)"><i class="fas fa-stopwatch"></i> Cronômetro</button>
        </div>

        <div id="dashboard" class="content active">
            <div class="dashboard-grid">
                <div class="card-stat"><h4>Horas Hoje</h4><div class="value" id="dash-hoje">0h 0m</div></div>
                <div class="card-stat"><h4>Horas na Semana</h4><div class="value" id="dash-semana">0h 0m</div></div>
                <div class="card-stat"><h4>Total Acumulado</h4><div class="value" id="dash-total">0h 0m</div></div>
            </div>
            <div class="chart-box">
                <h4 style="color:var(--tech-accent); font-family:'Rajdhani'; margin-bottom:15px; text-transform:uppercase;"><i class="fas fa-chart-bar"></i> Últimos 7 dias (Horas)</h4>
                <div style="height: 250px;"><canvas id="chartEvo"></canvas></div>
            </div>
        </div>

        <div id="edital" class="content">
            <div class="section-title">
                <span><i class="fas fa-graduation-cap"></i> Edital Verticalizado PCBA</span>
                <div style="display:flex; gap:10px;">
                    <button class="btn-primary" style="background:#2c3e50;" onclick="abrirModalImportar()"><i class="fas fa-paste"></i> Importar</button>
                    <button class="btn-primary" style="background:#8e24aa;" onclick="document.getElementById('modal-nova-materia').style.display='flex'"><i class="fas fa-plus"></i> Add Tópico</button>
                </div>
            </div>
            
            <div style="margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#888; font-weight:bold;"><span>PROGRESSO GERAL DO EDITAL</span><span id="edital-pct-text">0%</span></div>
                <div class="edital-progress-bar"><div id="edital-pct-fill" class="edital-progress-fill"></div></div>
            </div>

            <div class="table-container">
                <table id="tabela-edital">
                    <thead><tr><th style="width: 50px; text-align:center;">Item</th><th>Conteúdo Programático</th><th style="width:80px; text-align:center;">Estudado</th><th style="width:80px; text-align:center;">Revisado</th><th style="width:50px; text-align:center;">Ação</th></tr></thead>
                    <tbody id="tbody-edital"></tbody>
                </table>
            </div>
        </div>

        <div id="historico" class="content">
            <div class="section-title">
                <span><i class="fas fa-list"></i> Histórico de Atividades</span>
                <button class="btn-primary" style="background:#4caf50; color:#fff;" onclick="abrirModal()"><i class="fas fa-plus"></i> Cadastrar Atividade</button>
            </div>
            
            <div class="filter-bar">
                <div style="display:flex; align-items:center; gap:5px;"><label style="font-size:11px; color:#888; font-weight:bold;">DE</label><input type="date" id="f-data-ini" class="filter-control" onchange="renderHistorico()"></div>
                <div style="display:flex; align-items:center; gap:5px;"><label style="font-size:11px; color:#888; font-weight:bold;">ATÉ</label><input type="date" id="f-data-fim" class="filter-control" onchange="renderHistorico()"></div>
                <select id="f-materia" class="filter-control" onchange="renderHistorico()"><option value="">Todas as Matérias</option></select>
                <input type="text" id="f-busca" class="filter-control" placeholder="Buscar anotação/tópico..." onkeyup="renderHistorico()">
                <button class="btn-del" style="padding: 10px 15px; font-size:11px;" onclick="limparFiltrosHistorico()">LIMPAR</button>
            </div>
            
            <div class="table-container">
                <table id="tabela-atividades">
                    <thead><tr><th>Data</th><th>Matéria e Conteúdo</th><th>Anotações</th><th style="text-align:center;">Duração</th><th style="text-align:center;">Ações</th></tr></thead>
                    <tbody id="tbody-atividades"></tbody>
                </table>
            </div>
        </div>

        <div id="analise" class="content">
            <div class="section-title"><span><i class="fas fa-chart-line"></i> Tempo de Estudo</span></div>
            
            <div class="an-filter-container">
                <div class="an-dates-row">
                    <div class="quick-dates-group">
                        <button class="btn-quick-date" id="btn-an-7d" onclick="setAnalisePeriod('7d')">Semana</button>
                        <button class="btn-quick-date active" id="btn-an-30d" onclick="setAnalisePeriod('30d')">Mês</button>
                        <button class="btn-quick-date" id="btn-an-12m" onclick="setAnalisePeriod('12m')">Ano</button>
                        <button class="btn-quick-date" id="btn-an-all" onclick="setAnalisePeriod('all')">Total</button>
                    </div>
                    
                    <div style="flex:1; display:flex; gap:10px; align-items:flex-end;">
                        <div class="an-date-group"><label>INÍCIO</label><input type="date" id="an-data-ini" class="an-date-input" onchange="resetQuickButtons(); renderAnalise()"></div>
                        <div class="an-date-group"><label>FIM</label><input type="date" id="an-data-fim" class="an-date-input" onchange="resetQuickButtons(); renderAnalise()"></div>
                    </div>

                    <div class="an-date-group" style="min-width: 250px;">
                        <label>DISCIPLINA</label>
                        <select id="an-filtro-cat" class="aprovado-input" style="padding: 8px;" onchange="renderAnalise()"><option value="">Todas as Matérias</option></select>
                    </div>
                </div>
            </div>

            <div class="analysis-split">
                <div class="an-chart-container"><canvas id="chartPieAnalytics"></canvas></div>
                <div class="an-list-container">
                    <div style="margin-bottom: 20px;">
                        <h2 id="an-total-time" style="font-family:'Rajdhani'; color:var(--text-main); margin:0; font-size:32px;">0h 0m 0s</h2>
                        <span style="color:#888; font-size:12px;" id="an-periodo-lbl">Tempo total no período</span>
                    </div>
                    <div id="an-subject-list"></div>
                </div>
            </div>
        </div>

        <div id="cronometro" class="content">
            <h2 class="section-title"><i class="fas fa-stopwatch"></i> Modo Concentração</h2>
            <div class="timer-container">
                <div class="timer-display" id="timer-display">00:00:00</div>
                <div class="timer-controls">
                    <button class="btn-primary btn-timer" id="btn-start-timer" onclick="iniciarCronometro()" style="background:#4caf50"><i class="fas fa-play"></i> Iniciar</button>
                    <button class="btn-primary btn-timer" id="btn-pause-timer" style="background:#f39c12; display:none;" onclick="pausarCronometro()"><i class="fas fa-pause"></i> Pausar</button>
                    <button class="btn-del btn-timer" onclick="zerarCronometro()"><i class="fas fa-stop"></i> Zerar</button>
                </div>
                <div style="max-width: 500px; margin: 0 auto; text-align: left; margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px;">
                    <div class="aprovado-row">
                        <div class="aprovado-group"><label class="aprovado-label">Matéria</label><select id="c-materia" class="aprovado-input" onchange="atualizarTopicosCronometro()"></select></div>
                        <div class="aprovado-group"><label class="aprovado-label">Conteúdo</label><select id="c-conteudo" class="aprovado-input"><option value="">-- Opcional --</option></select></div>
                    </div>
                    <button class="btn-primary" style="width:100%; padding:15px; font-size:14px; margin-top:10px;" onclick="salvarDoCronometro()"><i class="fas fa-save"></i> FINALIZAR E SALVAR</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DB_KEY = "peixinho_controle_estudos_v3";
        const EDITAL_KEY = "peixinho_edital_tracker_v2";
        
        let dbEstudos = [];
        let dbEdital = [];
        
        // Base Edital PCBA Exato (PDF)
        const editalPadraoPCBA = [
            { materia: "LÍNGUA PORTUGUESA", topicos: [ { id: 101, nome: "Compreensão e interpretação de textos", estudado: false, revisado: false }, { id: 102, nome: "Tipologia textual", estudado: false, revisado: false }, { id: 103, nome: "Ortografia oficial e Acentuação gráfica", estudado: false, revisado: false }, { id: 104, nome: "Emprego das classes de palavras", estudado: false, revisado: false }, { id: 105, nome: "Emprego do sinal indicativo de crase", estudado: false, revisado: false }, { id: 106, nome: "Sintaxe da oração e do período / Pontuação", estudado: false, revisado: false }, { id: 107, nome: "Concordância e Regência (nominal e verbal)", estudado: false, revisado: false }, { id: 108, nome: "Significação das palavras", estudado: false, revisado: false }, { id: 109, nome: "Correspondência oficial (Manual PR)", estudado: false, revisado: false } ] },
            { materia: "RACIOCÍNIO LÓGICO", topicos: [ { id: 201, nome: "Estruturas lógicas", estudado: false, revisado: false }, { id: 202, nome: "Lógica de argumentação", estudado: false, revisado: false }, { id: 203, nome: "Lógica sentencial (Tabela verdade, equivalências)", estudado: false, revisado: false }, { id: 204, nome: "Princípios de contagem e probabilidade", estudado: false, revisado: false }, { id: 205, nome: "Operações com conjuntos", estudado: false, revisado: false } ] },
            { materia: "ATUALIDADES", topicos: [ { id: 301, nome: "Globalização: implicações sociais, econômicas", estudado: false, revisado: false }, { id: 302, nome: "Multiculturalidade e Diversidade", estudado: false, revisado: false }, { id: 303, nome: "Tecnologias de Informação e Comunicação", estudado: false, revisado: false } ] },
            { materia: "INFORMÁTICA", topicos: [ { id: 401, nome: "Conceito de internet e intranet", estudado: false, revisado: false }, { id: 402, nome: "Noções de sistema operacional (Windows)", estudado: false, revisado: false }, { id: 403, nome: "Hardware: placa mãe, memórias, processadores", estudado: false, revisado: false }, { id: 404, nome: "Editores de texto e planilhas (Word, Excel, Libre)", estudado: false, revisado: false }, { id: 405, nome: "Segurança: vírus, malware, phishing", estudado: false, revisado: false }, { id: 406, nome: "Navegadores e Computação na nuvem", estudado: false, revisado: false } ] },
            { materia: "IGUALDADE RACIAL E DE GÊNERO", topicos: [ { id: 501, nome: "CF/88 - Artigos 1º, 3º, 4º e 5º", estudado: false, revisado: false }, { id: 502, nome: "Estatuto da Igualdade Racial (Lei 12.288/10)", estudado: false, revisado: false }, { id: 503, nome: "Crimes de preconceito de raça ou cor (Lei 7.716)", estudado: false, revisado: false }, { id: 504, nome: "Lei Maria da Penha (Lei 11.340/06)", estudado: false, revisado: false } ] },
            { materia: "MEDICINA LEGAL", topicos: [ { id: 601, nome: "Conceito, corpo de delito, perícia e peritos", estudado: false, revisado: false }, { id: 602, nome: "Documentos médico-legais e Identificação", estudado: false, revisado: false }, { id: 603, nome: "Lesões por ação contundente, brancas e PAF", estudado: false, revisado: false }, { id: 604, nome: "Tanatologia Forense (Diagnóstico da morte)", estudado: false, revisado: false }, { id: 605, nome: "Asfixias e Crimes Sexuais", estudado: false, revisado: false } ] },
            { materia: "LEGISLAÇÃO GERAL", topicos: [ { id: 701, nome: "Estatuto do Servidor da Bahia (Lei 6.677/94)", estudado: false, revisado: false }, { id: 702, nome: "Lei Orgânica da PCBA (Lei 11.370/09)", estudado: false, revisado: false } ] },
            { materia: "CONTABILIDADE", topicos: [ { id: 801, nome: "Conceitos, objetivos e finalidades", estudado: false, revisado: false }, { id: 802, nome: "Patrimônio e Equação fundamental", estudado: false, revisado: false }, { id: 803, nome: "Atos e fatos administrativos", estudado: false, revisado: false }, { id: 804, nome: "Contas e Escrituração", estudado: false, revisado: false }, { id: 805, nome: "Balanço patrimonial e DRE", estudado: false, revisado: false } ] },
            { materia: "DIREITO ADMINISTRATIVO", topicos: [ { id: 901, nome: "Organização administrativa (Direta e Indireta)", estudado: false, revisado: false }, { id: 902, nome: "Ato administrativo", estudado: false, revisado: false }, { id: 903, nome: "Poderes administrativos", estudado: false, revisado: false }, { id: 904, nome: "Responsabilidade civil do Estado", estudado: false, revisado: false } ] },
            { materia: "DIREITO CONSTITUCIONAL", topicos: [ { id: 1001, nome: "Direitos e garantias fundamentais", estudado: false, revisado: false }, { id: 1002, nome: "Organização político-administrativa", estudado: false, revisado: false }, { id: 1003, nome: "Defesa do Estado e Segurança Pública", estudado: false, revisado: false } ] },
            { materia: "DIREITO PENAL", topicos: [ { id: 1101, nome: "Aplicação da lei penal (Tempo e Espaço)", estudado: false, revisado: false }, { id: 1102, nome: "Fato típico e ilicitude", estudado: false, revisado: false }, { id: 1103, nome: "Culpabilidade e Imputabilidade", estudado: false, revisado: false }, { id: 1104, nome: "Concurso de pessoas", estudado: false, revisado: false }, { id: 1105, nome: "Crimes contra a pessoa e patrimônio", estudado: false, revisado: false }, { id: 1106, nome: "Crimes contra a Administração Pública", estudado: false, revisado: false } ] },
            { materia: "DIREITO PROCESSUAL PENAL", topicos: [ { id: 1201, nome: "Inquérito policial", estudado: false, revisado: false }, { id: 1202, nome: "Prova e Cadeia de Custódia", estudado: false, revisado: false }, { id: 1203, nome: "Prisão (Flagrante, Preventiva e Temporária)", estudado: false, revisado: false } ] },
            { materia: "LEGISLAÇÃO EXTRAVAGANTE", topicos: [ { id: 1301, nome: "Tráfico de Drogas (Lei 11.343/06)", estudado: false, revisado: false }, { id: 1302, nome: "Crime Organizado (Lei 12.850/13)", estudado: false, revisado: false }, { id: 1303, nome: "Crimes Hediondos (Lei 8.072/90)", estudado: false, revisado: false }, { id: 1304, nome: "Estatuto do Desarmamento (Lei 10.826/03)", estudado: false, revisado: false }, { id: 1305, nome: "Abuso de Autoridade (Lei 13.869/19)", estudado: false, revisado: false } ] }
        ];

        const chartColors = ['#007bff', '#6610f2', '#6f42c1', '#e83e8c', '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997', '#17a2b8', '#343a40', '#adb5bd'];

        let timerInterval, timerSeconds = 0, timerRunning = false;
        let chartEvoInstance = null, chartPieAnalyticsInstance = null;

        // --- INICIALIZAÇÃO ---
        window.addEventListener('message', function(event) { if (event.data && event.data.theme) { (event.data.theme === 'light') ? document.body.classList.add('light-mode') : document.body.classList.remove('light-mode'); } });

        window.onload = function() {
            if(localStorage.getItem('peixinho_theme') === 'light') document.body.classList.add('light-mode');
            carregarLocal();
        };

        function carregarLocal() {
            const d = localStorage.getItem(DB_KEY);
            if(d) dbEstudos = JSON.parse(d);

            const ed = localStorage.getItem(EDITAL_KEY);
            if(ed) {
                dbEdital = JSON.parse(ed);
            } else {
                dbEdital = JSON.parse(JSON.stringify(editalPadraoPCBA)); // Clone
                localStorage.setItem(EDITAL_KEY, JSON.stringify(dbEdital));
            }

            atualizarSelectsMaterias();
            setAnalisePeriod('30d'); 
            renderizarTudo();
        }

        function salvarLocal() {
            localStorage.setItem(DB_KEY, JSON.stringify(dbEstudos));
            localStorage.setItem(EDITAL_KEY, JSON.stringify(dbEdital));
        }
        
        function mostrarToast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
            t.style.display = 'block';
            setTimeout(() => { t.style.display='none'; }, 3000);
        }

        function atualizarSelectsMaterias() {
            const sels = ['m-materia', 'c-materia', 'f-materia', 'an-filtro-cat'];
            const selModalNova = document.getElementById('nova-topico-materia');
            
            // Pega lista de matérias únicas do Edital
            const materias = dbEdital.map(m => m.materia).sort();
            
            sels.forEach(id => {
                const el = document.getElementById(id);
                if(!el) return;
                const isFiltro = (id === 'f-materia' || id === 'an-filtro-cat');
                el.innerHTML = isFiltro ? '<option value="">Todas as Matérias</option>' : '<option value="">-- Escolha uma matéria --</option>';
                materias.forEach(m => el.add(new Option(m, m)));
            });
            
            if(selModalNova) {
                selModalNova.innerHTML = '<option value="">[ + CRIAR NOVA MATÉRIA ]</option>';
                materias.forEach(m => selModalNova.add(new Option(m, m)));
            }
        }

        function atualizarTopicosRegistro() {
            const mat = document.getElementById('m-materia').value;
            const selTop = document.getElementById('m-conteudo');
            selTop.innerHTML = '<option value="">-- Escolha um conteúdo --</option>';
            const cat = dbEdital.find(c => c.materia === mat);
            if(cat && cat.topicos) cat.topicos.forEach(t => selTop.add(new Option(t.nome, t.nome)));
        }
        function atualizarTopicosCronometro() {
            const mat = document.getElementById('c-materia').value;
            const selTop = document.getElementById('c-conteudo');
            selTop.innerHTML = '<option value="">-- Opcional --</option>';
            const cat = dbEdital.find(c => c.materia === mat);
            if(cat && cat.topicos) cat.topicos.forEach(t => selTop.add(new Option(t.nome, t.nome)));
        }

        function nav(id, btn) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');
            if(id === 'dashboard') renderDashboard();
            if(id === 'historico') renderHistorico();
            if(id === 'analise') renderAnalise();
            if(id === 'edital') renderEdital();
        }

        function renderizarTudo() { renderDashboard(); renderHistorico(); renderEdital(); }

        // --- UTILITARIOS ---
        function formataHoras(minutosTotal) { const h = Math.floor(minutosTotal / 60); const m = Math.floor(minutosTotal % 60); return h > 0 ? `${h}h ${m}m` : `${m}m`; }
        function formataHorasSegundos(minutosTotal) { const h = Math.floor(minutosTotal / 60); const m = Math.floor(minutosTotal % 60); return h > 0 ? `${h}h ${m}m 0s` : `${m}m 0s`; }
        function formataDecimal(minutosTotal) { return (minutosTotal / 60).toFixed(1); }
        function minToHHMM(minutos) { const h = Math.floor(minutos / 60); const m = minutos % 60; return `${h}:${String(m).padStart(2,'0')}`; }
        function getDataFormatada(dateObj) { return `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}-${String(dateObj.getDate()).padStart(2,'0')}`; }
        function parseDataBR(dataISO) { return dataISO.split('-').reverse().join('/'); }

        // --- ABA: EDITAL E IMPORTAÇÃO ---
        function renderEdital() {
            const tb = document.getElementById('tbody-edital');
            tb.innerHTML = '';
            
            let totEstudado = 0;
            let totItems = 0;

            dbEdital.forEach((cat, index) => {
                tb.innerHTML += `<tr class="edital-header-row"><td colspan="4">${index + 1}. ${cat.materia}</td><td style="text-align:center"><button class="btn-del" style="background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.3); padding:4px 8px; font-size:10px;" onclick="excluirMateriaEdital('${cat.materia}')"><i class="fas fa-trash"></i></button></td></tr>`;
                
                cat.topicos.forEach((topico, tIndex) => {
                    totItems++;
                    if(topico.estudado) totEstudado++;
                    
                    tb.innerHTML += `
                        <tr class="edital-item-row">
                            <td class="edital-num">${index + 1}.${tIndex + 1}</td>
                            <td>${topico.nome}</td>
                            <td style="text-align:center"><input type="checkbox" class="chk-edital" ${topico.estudado ? 'checked' : ''} onchange="toggleEditalCheck('${cat.materia}', ${topico.id}, 'estudado', this.checked)"></td>
                            <td style="text-align:center"><input type="checkbox" class="chk-edital" ${topico.revisado ? 'checked' : ''} onchange="toggleEditalCheck('${cat.materia}', ${topico.id}, 'revisado', this.checked)"></td>
                            <td style="text-align:center"><button class="btn-icon btn-del" style="width:25px; height:25px; font-size:10px; background:transparent; color:#ef5350;" onclick="excluirTopicoEdital('${cat.materia}', ${topico.id})"><i class="fas fa-times"></i></button></td>
                        </tr>
                    `;
                });
            });

            const pctGlobal = totItems > 0 ? ((totEstudado / totItems) * 100).toFixed(1) : 0;
            document.getElementById('edital-pct-text').innerText = `${pctGlobal}% CONCLUÍDO`;
            document.getElementById('edital-pct-fill').style.width = `${pctGlobal}%`;
        }

        function toggleEditalCheck(materiaNome, topicoId, campo, isChecked) {
            const mat = dbEdital.find(m => m.materia === materiaNome);
            if(mat) {
                const top = mat.topicos.find(t => t.id === topicoId);
                if(top) { top[campo] = isChecked; salvarLocal(); renderEdital(); }
            }
        }

        function abrirModalImportar() {
            document.getElementById('import-texto').value = '';
            document.getElementById('modal-importar').style.display = 'flex';
        }

        function processarImportacao() {
            const txt = document.getElementById('import-texto').value;
            if(!txt.trim()) return alert("Cole o texto do edital primeiro.");

            const linhas = txt.split('\n');
            let materiaAtualObj = null;
            let importados = 0;

            linhas.forEach(linha => {
                let l = linha.trim();
                if(!l) return;
                
                // Remove caixinhas ou marcadores de PDF se vierem "☐"
                l = l.replace(/☐|☑/g, '').trim();
                if(!l) return;

                const matchTopico = l.match(/^(\d+\.\d+(?:\.\d+)?)\s+(.+)$/);
                const matchMateria = l.match(/^(\d+)\s+(.+)$/);
                
                if(matchTopico) {
                    if(!materiaAtualObj) {
                        materiaAtualObj = { materia: "CONTEÚDO EXTRA", topicos: [] };
                        dbEdital.push(materiaAtualObj);
                    }
                    materiaAtualObj.topicos.push({ id: Date.now() + Math.random(), nome: matchTopico[2], estudado: false, revisado: false });
                    importados++;
                } else if (matchMateria) {
                    let nomeMat = matchMateria[2].toUpperCase();
                    materiaAtualObj = dbEdital.find(m => m.materia === nomeMat);
                    if(!materiaAtualObj) {
                        materiaAtualObj = { materia: nomeMat, topicos: [] };
                        dbEdital.push(materiaAtualObj);
                    }
                } else {
                    if(l === l.toUpperCase() && l.length > 3) {
                        let nomeMat = l;
                        materiaAtualObj = dbEdital.find(m => m.materia === nomeMat);
                        if(!materiaAtualObj) {
                            materiaAtualObj = { materia: nomeMat, topicos: [] };
                            dbEdital.push(materiaAtualObj);
                        }
                    } else {
                        if(!materiaAtualObj) {
                            materiaAtualObj = { materia: "DIVERSOS", topicos: [] };
                            dbEdital.push(materiaAtualObj);
                        }
                        materiaAtualObj.topicos.push({ id: Date.now() + Math.random(), nome: l, estudado: false, revisado: false });
                        importados++;
                    }
                }
            });

            salvarLocal();
            atualizarSelectsMaterias();
            renderEdital();
            document.getElementById('modal-importar').style.display = 'none';
            mostrarToast(`Importação concluída! ${importados} tópicos processados.`);
        }

        function salvarNovoTopicoEdital() {
            const matSel = document.getElementById('nova-topico-materia').value;
            const topNome = document.getElementById('nova-topico-input').value.trim();
            
            if(!topNome) return alert("Digite o nome da matéria/tópico!");

            if(matSel) {
                const mat = dbEdital.find(m => m.materia === matSel);
                mat.topicos.push({ id: Date.now(), nome: topNome, estudado: false, revisado: false });
            } else {
                const novaMat = topNome.toUpperCase();
                if(!dbEdital.find(m => m.materia === novaMat)) {
                    dbEdital.push({ materia: novaMat, topicos: [] });
                }
            }
            salvarLocal(); atualizarSelectsMaterias(); renderEdital();
            document.getElementById('nova-topico-input').value = '';
            document.getElementById('modal-nova-materia').style.display='none';
            mostrarToast("Adicionado ao edital!");
        }

        function excluirMateriaEdital(nome) { if(confirm("Apagar matéria inteira e todos os tópicos?")) { dbEdital = dbEdital.filter(m => m.materia !== nome); salvarLocal(); atualizarSelectsMaterias(); renderEdital(); } }
        function excluirTopicoEdital(nomeMat, idTopico) { if(confirm("Remover este tópico?")) { const mat = dbEdital.find(m => m.materia === nomeMat); if(mat) { mat.topicos = mat.topicos.filter(t => t.id !== idTopico); salvarLocal(); renderEdital(); } } }

        // --- ABA: ANÁLISE ---
        function setAnalisePeriod(periodo) {
            document.querySelectorAll('.btn-quick-date').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-an-'+periodo).classList.add('active');

            const dtFim = new Date();
            let dtIni = new Date();

            if(periodo === '7d') dtIni.setDate(dtFim.getDate() - 6);
            else if(periodo === '30d') dtIni.setDate(dtFim.getDate() - 29);
            else if(periodo === '12m') dtIni.setFullYear(dtFim.getFullYear() - 1);
            else if(periodo === 'all') { dtIni = null; }

            document.getElementById('an-data-fim').value = getDataFormatada(dtFim);
            document.getElementById('an-data-ini').value = dtIni ? getDataFormatada(dtIni) : '';
            renderAnalise();
        }

        function resetQuickButtons() { document.querySelectorAll('.btn-quick-date').forEach(b => b.classList.remove('active')); }

        function renderAnalise() {
            const dtIni = document.getElementById('an-data-ini').value;
            const dtFim = document.getElementById('an-data-fim').value;
            const materiaFiltro = document.getElementById('an-filtro-cat').value;

            let filtered = [...dbEstudos];
            if(dtIni) filtered = filtered.filter(e => e.data >= dtIni);
            if(dtFim) filtered = filtered.filter(e => e.data <= dtFim);
            if(materiaFiltro) filtered = filtered.filter(e => e.materia === materiaFiltro);

            let minPeriodo = 0;
            const resumoMaterias = {};

            filtered.forEach(e => {
                const min = parseInt(e.duracao);
                minPeriodo += min;
                resumoMaterias[e.materia] = (resumoMaterias[e.materia] || 0) + min;
            });

            document.getElementById('an-total-time').innerText = formataHorasSegundos(minPeriodo);
            
            let dateLabel = "Geral";
            if(dtIni && dtFim) dateLabel = `${parseDataBR(dtIni)} a ${parseDataBR(dtFim)}`;
            document.getElementById('an-periodo-lbl').innerText = `Tempo total em ${dateLabel}`;

            let arrMats = Object.keys(resumoMaterias).map(mat => { return { nome: mat, min: resumoMaterias[mat] }; });
            arrMats.sort((a, b) => b.min - a.min);

            const labelsPie = []; const dataPie = []; const bgColors = [];
            const listContainer = document.getElementById('an-subject-list');
            listContainer.innerHTML = '';

            if(arrMats.length === 0) {
                listContainer.innerHTML = '<div style="color:#888; font-size:14px;">Sem dados para analisar neste período.</div>';
                if(chartPieAnalyticsInstance) chartPieAnalyticsInstance.destroy();
                return;
            }

            arrMats.forEach((item, index) => {
                labelsPie.push(item.nome); dataPie.push(item.min);
                const color = chartColors[index % chartColors.length];
                bgColors.push(color);
                const pct = minPeriodo > 0 ? ((item.min / minPeriodo) * 100).toFixed(1) : 0;
                listContainer.innerHTML += `<div class="an-list-item"><span class="an-dot" style="background-color: ${color}"></span><span class="an-materia-nome">${item.nome}</span><span class="an-tempo"><i class="far fa-clock"></i> ${formataHoras(item.min)}</span><span class="an-pct">(${pct}%)</span></div>`;
            });

            const ctxPie = document.getElementById('chartPieAnalytics').getContext('2d');
            if(chartPieAnalyticsInstance) chartPieAnalyticsInstance.destroy();
            chartPieAnalyticsInstance = new Chart(ctxPie, { type: 'pie', data: { labels: labelsPie, datasets: [{ data: dataPie, backgroundColor: bgColors, borderColor: 'transparent' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} } } });
        }

        // --- ABA: REGISTRO E HISTÓRICO ---
        function setQuickDate(type) {
            const btns = ['btn-hoje', 'btn-ontem', 'btn-outro'];
            btns.forEach(b => document.getElementById(b).classList.remove('active'));
            document.getElementById('btn-'+type).classList.add('active');
            const inputDate = document.getElementById('m-data');
            if(type === 'hoje') { inputDate.style.display = 'none'; inputDate.value = getDataFormatada(new Date()); } 
            else if(type === 'ontem') { inputDate.style.display = 'none'; const ontem = new Date(); ontem.setDate(ontem.getDate() - 1); inputDate.value = getDataFormatada(ontem); } 
            else { inputDate.style.display = 'block'; if(!inputDate.value) inputDate.value = getDataFormatada(new Date()); }
        }

        function abrirModal(id = null) {
            document.getElementById('edit-id').value = '';
            document.getElementById('m-materia').value = '';
            document.getElementById('m-conteudo').innerHTML = '<option value="">-- Escolha um conteúdo --</option>';
            document.getElementById('m-duracao-horas').value = '';
            document.getElementById('m-duracao-min').value = '';
            document.getElementById('m-notas').value = '';
            setQuickDate('hoje');

            if(id) {
                const item = dbEstudos.find(x => x.id == id);
                if(item) {
                    document.getElementById('edit-id').value = item.id;
                    document.getElementById('m-materia').value = item.materia;
                    atualizarTopicosRegistro(); 
                    document.getElementById('m-conteudo').value = item.conteudo || '';
                    document.getElementById('m-duracao-horas').value = Math.floor(item.duracao / 60) || '';
                    document.getElementById('m-duracao-min').value = item.duracao % 60 || '';
                    document.getElementById('m-notas').value = item.notas || '';
                    document.getElementById('m-data').value = item.data; 
                    setQuickDate('outro'); 
                }
            }
            document.getElementById('modal-atividade').style.display = 'flex';
        }

        function salvarAtividade() {
            const id = document.getElementById('edit-id').value;
            const materia = document.getElementById('m-materia').value;
            const conteudo = document.getElementById('m-conteudo').value;
            const data = document.getElementById('m-data').value;
            const hr = parseInt(document.getElementById('m-duracao-horas').value) || 0;
            const min = parseInt(document.getElementById('m-duracao-min').value) || 0;
            const duracao = (hr * 60) + min;
            const notas = document.getElementById('m-notas').value;

            if(!materia || !data || duracao <= 0) { alert("Selecione a Matéria e informe um Tempo válido de estudo."); return; }

            const obj = { id: id ? parseInt(id) : Date.now(), materia, conteudo, data, duracao, notas };
            if(id) { const idx = dbEstudos.findIndex(x => x.id == id); if(idx > -1) dbEstudos[idx] = obj; } 
            else { dbEstudos.push(obj); }

            salvarLocal(); renderizarTudo();
            if(document.getElementById('analise').classList.contains('active')) renderAnalise();

            document.getElementById('modal-atividade').style.display = 'none';
            mostrarToast("Registro de estudo salvo!");
        }

        function excluirAtividade(id) { if(confirm("Excluir definitivamente este registro?")) { dbEstudos = dbEstudos.filter(x => x.id != id); salvarLocal(); renderizarTudo(); if(document.getElementById('analise').classList.contains('active')) renderAnalise(); } }

        function limparFiltrosHistorico() { document.getElementById('f-data-ini').value = ''; document.getElementById('f-data-fim').value = ''; document.getElementById('f-materia').value = ''; document.getElementById('f-busca').value = ''; renderHistorico(); }
        
        function renderHistorico() {
            const dtIni = document.getElementById('f-data-ini').value; const dtFim = document.getElementById('f-data-fim').value;
            const materiaFiltro = document.getElementById('f-materia').value; const busca = document.getElementById('f-busca').value.toLowerCase();
            let lista = [...dbEstudos];

            if(dtIni) lista = lista.filter(d => d.data >= dtIni);
            if(dtFim) lista = lista.filter(d => d.data <= dtFim);
            if(materiaFiltro) lista = lista.filter(d => d.materia === materiaFiltro);
            if(busca) { lista = lista.filter(d => (d.conteudo && d.conteudo.toLowerCase().includes(busca)) || (d.notas && d.notas.toLowerCase().includes(busca))); }
            lista.sort((a,b) => new Date(b.data) - new Date(a.data));

            const tb = document.getElementById('tbody-atividades'); tb.innerHTML = '';
            if(lista.length === 0) { tb.innerHTML = '<tr><td colspan="5" align="center" style="padding:20px; color:#888;">Nenhum estudo encontrado.</td></tr>'; return; }

            lista.forEach(d => {
                let detalhesHtml = '';
                if(d.conteudo) detalhesHtml += `<div style="font-size:12px; color:var(--text-muted);">${d.conteudo}</div>`;
                if(d.notas) detalhesHtml += `<div style="font-size:11px; color:#888; font-style:italic; margin-top:2px;">"${d.notas.substring(0,30)}..."</div>`;

                tb.innerHTML += `<tr><td style="white-space:nowrap; font-weight:bold;">${parseDataBR(d.data)}</td><td><span class="subject-badge">${d.materia}</span>${detalhesHtml}</td><td style="text-align:center; font-family:'Courier New';">-</td><td style="font-family:'Rajdhani'; font-weight:bold; font-size:16px; color:var(--tech-accent); text-align:center">${formataHoras(d.duracao)}</td><td style="white-space:nowrap"><button class="btn-icon btn-edit" onclick="abrirModal(${d.id})"><i class="fas fa-pen"></i></button> <button class="btn-icon btn-del" onclick="excluirAtividade(${d.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        // --- DASHBOARD ---
        function renderDashboard() {
            const hoje = new Date(); const hojeStr = getDataFormatada(hoje); const diaSemana = hoje.getDay(); const inicioSemana = new Date(hoje); inicioSemana.setDate(hoje.getDate() - diaSemana); const inicioSemanaStr = getDataFormatada(inicioSemana);
            let minHoje = 0, minSemana = 0, minTotal = 0; const ultimos7Dias = {};
            for(let i=6; i>=0; i--) { let d = new Date(); d.setDate(d.getDate() - i); let label = d.toLocaleDateString('pt-BR', {weekday: 'short'}); if(i===0) label = "hoje"; ultimos7Dias[getDataFormatada(d)] = { label: label, min: 0 }; }
            dbEstudos.forEach(e => { const min = parseInt(e.duracao); minTotal += min; if(e.data === hojeStr) minHoje += min; if(e.data >= inicioSemanaStr && e.data <= hojeStr) minSemana += min; if(ultimos7Dias[e.data]) ultimos7Dias[e.data].min += min; });
            document.getElementById('dash-hoje').innerText = formataHoras(minHoje); document.getElementById('dash-semana').innerText = formataHoras(minSemana); document.getElementById('dash-total').innerText = formataHoras(minTotal);
            const labelsBar = []; const dataBar = []; for (let dt in ultimos7Dias) { labelsBar.push(ultimos7Dias[dt].label); dataBar.push(formataDecimal(ultimos7Dias[dt].min)); }
            const ctxEvo = document.getElementById('chartEvo').getContext('2d'); if(chartEvoInstance) chartEvoInstance.destroy();
            chartEvoInstance = new Chart(ctxEvo, { type: 'bar', data: { labels: labelsBar, datasets: [{ label: 'Horas Estudadas', data: dataBar, backgroundColor: '#ff4081', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { y: { grid: { color: '#333' } }, x: { grid: { display: false } } } } });
        }

        // --- CRONÔMETRO ---
        function atualizarDisplayTimer() { const h = Math.floor(timerSeconds / 3600); const m = Math.floor((timerSeconds % 3600) / 60); const s = timerSeconds % 60; document.getElementById('timer-display').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }
        function iniciarCronometro() { if(timerRunning) return; timerRunning = true; document.getElementById('btn-start-timer').style.display = 'none'; document.getElementById('btn-pause-timer').style.display = 'inline-flex'; timerInterval = setInterval(() => { timerSeconds++; atualizarDisplayTimer(); }, 1000); }
        function pausarCronometro() { timerRunning = false; clearInterval(timerInterval); document.getElementById('btn-start-timer').style.display = 'inline-flex'; document.getElementById('btn-pause-timer').style.display = 'none'; document.getElementById('btn-start-timer').innerHTML = '<i class="fas fa-play"></i> Continuar'; }
        function zerarCronometro() { pausarCronometro(); timerSeconds = 0; atualizarDisplayTimer(); document.getElementById('btn-start-timer').innerHTML = '<i class="fas fa-play"></i> Iniciar'; }
        
        function salvarDoCronometro() {
            const minutos = Math.floor(timerSeconds / 60);
            if(minutos < 1) { alert("Sessão muito curta! Estude pelo menos 1 minuto."); return; }
            const mat = document.getElementById('c-materia').value; const cont = document.getElementById('c-conteudo').value;
            if(!mat) { alert("Selecione a Matéria Alvo antes de salvar a sessão."); return; }
            
            dbEstudos.push({ id: Date.now(), materia: mat, conteudo: cont, data: getDataFormatada(new Date()), duracao: minutos, notas: "Estudo Cronometrado" });
            zerarCronometro(); document.getElementById('c-materia').value = ''; document.getElementById('c-conteudo').value = '';
            salvarLocal(); renderizarTudo(); mostrarToast(`Sessão de ${minutos} min salva!`);
        }
    </script>
</body>
</html>
